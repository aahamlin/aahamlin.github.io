---
layout: post
title: Creating AWS Amplify Elm Project
---

## Install Amplify CLI globally

```
$ sudo npm -g @aws-amplify/cli

----------------------------------------
Successfully installed the Amplify CLI
----------------------------------------

JavaScript Getting Started - https://aws-amplify.github.io/docs/js/start

Android Getting Started - https://aws-amplify.github.io/docs/android/start

iOS Getting Started - https://aws-amplify.github.io/docs/ios/start
```

## Progressive Web App in Elm

I am interested in creating this as a progressive web app, and following this article [https://codeburst.io/how-to-make-an-elm-app-progressive-d2e17d2f6fea](https://codeburst.io/how-to-make-an-elm-app-progressive-d2e17d2f6fea). I chose not to go the `create-elm-app` approach for the following reasons:
 - its not upgraded to elm 0.19.1
 - the npm install failed with fatal erros after given me a zillion deprecration warnings
 - in general, I avoid these boilerplate setup programs due to bias

The steps I run through are:
 - Initialize a new elm 0.19.1 project
 - Initialize a node project
 - Install webpack-cli as a dev dependency
 

```
$ elm init
$ npm init
$ npm i --save-dev webpack-cli

```

Hmm, there are a number of updated steps not mentioned in the article because my local environment is missing some dependencies \(maybe the author installed them globally\?\) and/or because the newer versions of elm and other modules.

```
$ npm i -D webpack@4
$ npm i -D file-loader
$ npm i -D elm-webpack-loader
$ npm i -D webpack-dev-server
```

After all this my package.json has been updated as follows.

> Note the project referenced by the article installs all of the above packages as "dependencies" rather than "devDependencies" but as the build output we are creating is all generated by webpack build steps, I think that that is incorrectly. *I may be wrong*. In which case, I'll come back and update this statement.

package.json:
```
{
    "main": "webpack.config.js",
    "dependencies": {},
    "devDependencies": {
        "elm-webpack-loader": "^6.0.1",
        "file-loader": "^6.0.0",
        "webpack": "^4.42.1",
        "webpack-cli": "^3.3.11",
        "webpack-dev-server": "^3.10.3",
    },
    "scripts": {
        "build": "webpack --mode=production",
        "start": "webpack-dev-server --port=3000 --mode=development",
        "test": "echo \"Error: no test specified\" && exit 1"
    },
}
```

When I run `npm run build` the errors about webpack, file-loader, and elm-webpack-loader have been resolved. But, there is a new error related to the updated version of Elm.

```
ERROR in ./src/Main.elm
Module build failed (from ./node_modules/elm-webpack-loader/index.js):
Error: Compiler process exited with error "node-elm-compiler received the `warn` option, but that was removed in Elm 0.19. Try re-running without passing the `warn` option."
    at /home/andrew/src/rezumei/node_modules/elm-webpack-loader/index.js:192:28
 @ ./src/index.js 6:10-31
 @ multi ./src/index.js
```

Easy enough, go to `webpack.config.js` and edit the elm-webpack-loader to remove the warn option.

Yay! The first build error goes away... but, another Elm 0.19.1 requirement pops up.

```
Compiling ...-- MODULE NAME MISSING -------------------------------------------- src/Main.elm

I need the module name to be declared at the top of this file, like this:

    module Main exposing (..)

Try adding that as the first line of your file!
```

After doing exactly what the Elm compiler told me to do. Success!

```
$ npm run build

> rezumei@1.0.0 build /home/andrew/src/rezumei
> npx webpack --mode=production

Running elm make /home/andrew/src/rezumei/src/Main.elm --output /tmp/2020318-14775-vm9mqh.xuc6h.js
Success! Compiled 1 module.

    Main ───> /tmp/2020318-14775-vm9mqh.xuc6h.js


Hash: d1ce025d10e2024ca6f3
Version: webpack 4.42.1
Time: 1488ms
Built at: 04/18/2020 3:19:52 PM
     Asset       Size  Chunks             Chunk Names
    app.js   23.9 KiB       0  [emitted]  app
index.html  266 bytes          [emitted]  
Entrypoint app = app.js
[0] multi ./src/index.js 28 bytes {0} [built]
[1] ./src/index.js 236 bytes {0} [built]
[2] ./src/index.html 54 bytes {0} [built]
[3] ./src/Main.elm 88.1 KiB {0} [built]
```

So far so good. Our Elm app compiles successfully. However, when I run it `npm run start` the web output is a blank page. Looking at the webpack-dev-server output, the file being served is what will become the `app.js` file during the build step, in our case `src/index.js`. 

```
$ npm run start

> rezumei@1.0.0 start /home/andrew/src/rezumei
> webpack-dev-server --port=3000 --mode=development

ℹ ｢wds｣: Project is running at http://localhost:3000/
ℹ ｢wds｣: webpack output is served from /
ℹ ｢wds｣: Content not from webpack is served from /home/andrew/src/rezumei
Running elm make /home/andrew/src/rezumei/src/Main.elm --output /tmp/2020318-15752-12j4e07.9e6hj.js
Success!     

    Main ───> /tmp/2020318-15752-12j4e07.9e6hj.js


ℹ ｢wdm｣: Hash: eea91190fcbf33a133ff
Version: webpack 4.42.1
Time: 735ms
Built at: 04/18/2020 4:08:32 PM
     Asset       Size  Chunks             Chunk Names
    app.js    460 KiB     app  [emitted]  app
index.html  266 bytes          [emitted]  
Entrypoint app = app.js
[1] multi (webpack)-dev-server/client?http://localhost:3000 ./src/index.js 40 bytes {app} [built]
...
```

What has happened? The Elm upgrade to 0.19 requires us to initialize the elm app differently than before. The repo from the article contains the upgrade to 0.19 commits. This explains why I was seeing a difference between the Elm 0.19 reference documentation and projects and the article's code. 

The article's update contains this bootstrap code in `src/index.js`
```
'use strict';

// require index.html for webpack copy to dist/
require('./index.html');

const {Elm} = require('./Main.elm');

Elm.Main.init({
    node: document.getElementById('main'),
});
```

> Note that the Elm reference projects use a slightly different syntax where their Elm.Main.init() call does not refer to a node in the DOM.

Trying `npm run start` after correctly the elm syntax and now the simple Elm UI displays our "hello" text. Now I can continue following the article on creating the PWA.

Having read and reviewed the manual steps, I am skipping ahead to making the dynamic build. This requires installing some more node modules. Again, I am under the assumption these can be installed as "devDependencies" until such time as this doesn't work for me. 

> Note to avoid kruft in the output directory, e.g. "dist", I have added clean-webpack-plugin to the mix.

```
$ npm i -D sw-precache-webpack-plugin
$ npm i -D webpack-pwa-manifest
$ npm i -D clean-webpack-plugin
```



Next, I'll hook this up to AWS Amplify to publish the initial version.
